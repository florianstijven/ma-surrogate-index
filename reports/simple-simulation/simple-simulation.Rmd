---
title: "Simple Simulation Illustration"
author: "Florian Stijven"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sandwich)
library(lmtest)
```


```{r}
# Source functions for the moment-based estimator
source(here::here("R", "helper-functions", "moment-based-estimator.R"))
source(here::here("R", "helper-functions", "delta-method-rho-trial.R"))
# Source functions to simulate data
source(here::here("R", "helper-functions", "simulation-functions.R"))

# Function to train the clinical prediction model and return prediction function.
train_clinical_prediction_model <- function(simulated_data) {
  # Train a correctly specified linear regression model for predicting the
  # clinical endpoint given the surrogate and baseline covariate
  clinical_model <- lm(clinical ~ surrogate * covariate + surrogate ^ 2, data = simulated_data)

  return(
    function(newdata) {
      return(predict(clinical_model, newdata = newdata))
    }
  )
}
```


# Illustration of Simulated data

## Individual-Patient Data

```{r}
# Generate IPD for a meta-analytic setting
ma_ipd_tbl = simulate_trials_with_random_coefficients(
  N = 10,
  n = 2e3,
  sd_beta_clin_surrogate_sq = 0.10,
  sd_beta_clin_treatment = 0.10
)
# Estimate "predcition model", which is just a correctly specified linear
# regression model.
surr_index_pred_f = train_clinical_prediction_model(ma_ipd_tbl)
# Add surrogate indew to IPD data
ma_ipd_tbl$surr_index = surr_index_pred_f(ma_ipd_tbl)
```

```{r}
# Plot the surrogate against the clinical endpoint.
ma_ipd_tbl %>%
  ggplot(aes(x = surrogate, y = clinical, color = as.factor(covariate))) +
  geom_point(alpha = 0.1) +
  facet_wrap("trial")
```

```{r}
# Plot the surrogate index against the clinical endpoint.
ma_ipd_tbl %>%
  ggplot(aes(x = surr_index, y = clinical)) +
  geom_point(alpha = 0.1) +
  geom_smooth(aes(group = as.factor(trial))) +
  facet_wrap("trial") +
  geom_abline(intercept = 0, slope = 1)
```


## Trial-Level Treatment Effects

```{r}
ma_trt_effect_tbl = ma_ipd_tbl %>%
  group_by(trial) %>%
  reframe(compute_treatment_effects(pick(everything()))) %>%
  ungroup()

ma_trt_effect_index_tbl = ma_ipd_tbl %>%
  select(-surrogate) %>%
  rename(surrogate = surr_index) %>%
  group_by(trial) %>%
  reframe(compute_treatment_effects(pick(everything()))) %>%
  ungroup()
```

```{r}
# Create a scatter plot with treatment effects on surrogate vs. clinical, including 95% CI error bars
ggplot(ma_trt_effect_tbl, aes(x = treatment_effect_surr, y = treatment_effect_clin)) +
  # Scatter plot of treatment effects
  geom_point() +
  # Horizontal error bars for surrogate treatment effect
  geom_errorbarh(aes(xmin = treatment_effect_surr - 1.96 * se_surr, 
                     xmax = treatment_effect_surr + 1.96 * se_surr), 
                 height = 0.05) +
  # Vertical error bars for clinical treatment effect
  geom_errorbar(aes(ymin = treatment_effect_clin - 1.96 * se_clin, 
                    ymax = treatment_effect_clin + 1.96 * se_clin), 
                width = 0.05) +
  # Labels and title
  labs(
    x = "Treatment Effect on Surrogate Endpoint",
    y = "Treatment Effect on Clinical Endpoint",
    title = "Treatment Effects on Surrogate vs. Clinical Endpoint with 95% Confidence Intervals"
  ) 
```

```{r}
# Create a scatter plot with treatment effects on surrogate vs. clinical, including 95% CI error bars
ggplot(ma_trt_effect_index_tbl, aes(x = treatment_effect_surr, y = treatment_effect_clin)) +
  # Scatter plot of treatment effects
  geom_point() +
  # Horizontal error bars for surrogate treatment effect
  geom_errorbarh(aes(xmin = treatment_effect_surr - 1.96 * se_surr, 
                     xmax = treatment_effect_surr + 1.96 * se_surr), 
                 height = 0.05) +
  # Vertical error bars for clinical treatment effect
  geom_errorbar(aes(ymin = treatment_effect_clin - 1.96 * se_clin, 
                    ymax = treatment_effect_clin + 1.96 * se_clin), 
                width = 0.05) +
  # Labels and title
  labs(
    x = "Treatment Effect on Surrogate Endpoint",
    y = "Treatment Effect on Clinical Endpoint",
    title = "Treatment Effects on Surrogate vs. Clinical Endpoint with 95% Confidence Intervals"
  ) +
  geom_abline(intercept = 0, slope = 1)
```

## Moment-Based Estimator

```{r}
# Estimate the meta-analytic parameters using the moment-based estimator.
moment_estimate_surr = moment_estimator(
  ma_trt_effect_tbl$treatment_effect_surr,
  ma_trt_effect_tbl$treatment_effect_clin,
  ma_trt_effect_tbl$covariance_matrix
)
rho_est_surr = rho_delta_method(moment_estimate_surr$coefs, moment_estimate_surr$vcov)


moment_estimate_surr_index = moment_estimator(
  ma_trt_effect_index_tbl$treatment_effect_surr,
  ma_trt_effect_index_tbl$treatment_effect_clin,
  ma_trt_effect_index_tbl$covariance_matrix
)
rho_est_surr_index = rho_delta_method(moment_estimate_surr_index$coefs,
                                      moment_estimate_surr_index$vcov)
```
# Simulation Results

```{r}
# Read in simulation results.
meta_analytic_data_simulated <- readRDS(
  here::here(
    "results",
    "raw-results",
    "simple-simulation",
    "meta_analytic_data_simulated.rds"
  )
)
```

```{r}
# Compute coverage, mean bias, median bias, empirical SD, and mean SE.
meta_analytic_data_simulated %>%
  group_by(analysis_type) %>%
  summarise(
    coverage = mean((rho_true >= rho_ci_lower) & (rho_true <= rho_ci_upper), na.rm = TRUE),
    mean_bias = mean(rho_est - rho_true, na.rm = TRUE),
    median_bias = median(rho_est - rho_true, na.rm = TRUE),
    emp_SD = sd(rho_est, na.rm = TRUE),
    meanSE = mean(rho_se, na.rm = TRUE)
  )
```


